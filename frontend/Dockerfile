FROM node:23.11.0-bullseye-slim as build-stage

WORKDIR /app
ENV LANG=C.UTF-8 \
    TZ=Asia/Tokyo

COPY ./app /app

RUN yarn install && yarn cache clean

ARG NUXT_PUBLIC_HTTP_PROTOCOL
ARG NUXT_PUBLIC_BACKEND_HOST
ARG NUXT_PUBLIC_BACKEND_PORT
ARG NUXT_PUBLIC_FRONTEND_HOST
ARG NUXT_PUBLIC_FRONTEND_PORT
ARG NUXT_PUBLIC_POSTS_PER_PAGE
ARG NUXT_PUBLIC_USERNAME_LENGTH_LIMIT
ARG NUXT_PUBLIC_UPLOAD_COMMENT_LENGTH_LIMIT
ARG NUXT_PUBLIC_FILESIZE_KB_LIMIT
ARG NUXT_PUBLIC_DELETE_PASSWORD_LENGTH_LIMIT
ARG NUXT_PUBLIC_OPTIONAL_TAG_LENGTH_LIMIT
ARG NUXT_PUBLIC_RECAPTCHA_SITEKEY
ARG NUXT_PUBLIC_RECAPTCHA_ENABLED

ENV NUXT_PUBLIC_HTTP_PROTOCOL=$NUXT_PUBLIC_HTTP_PROTOCOL
ENV NUXT_PUBLIC_BACKEND_HOST=$NUXT_PUBLIC_BACKEND_HOST
ENV NUXT_PUBLIC_BACKEND_PORT=$NUXT_PUBLIC_BACKEND_PORT
ENV NUXT_PUBLIC_FRONTEND_HOST=$NUXT_PUBLIC_FRONTEND_HOST
ENV NUXT_PUBLIC_FRONTEND_PORT=$NUXT_PUBLIC_FRONTEND_PORT
ENV NUXT_PUBLIC_POSTS_PER_PAGE=$NUXT_PUBLIC_POSTS_PER_PAGE
ENV NUXT_PUBLIC_USERNAME_LENGTH_LIMIT=$NUXT_PUBLIC_USERNAME_LENGTH_LIMIT
ENV NUXT_PUBLIC_UPLOAD_COMMENT_LENGTH_LIMIT=$NUXT_PUBLIC_UPLOAD_COMMENT_LENGTH_LIMIT
ENV NUXT_PUBLIC_FILESIZE_KB_LIMIT=$NUXT_PUBLIC_FILESIZE_KB_LIMIT
ENV NUXT_PUBLIC_DELETE_PASSWORD_LENGTH_LIMIT=$NUXT_PUBLIC_DELETE_PASSWORD_LENGTH_LIMIT
ENV NUXT_PUBLIC_OPTIONAL_TAG_LENGTH_LIMIT=$NUXT_PUBLIC_OPTIONAL_TAG_LENGTH_LIMIT
ENV NUXT_PUBLIC_RECAPTCHA_SITEKEY=$NUXT_PUBLIC_RECAPTCHA_SITEKEY
ENV NUXT_PUBLIC_RECAPTCHA_ENABLED=$NUXT_PUBLIC_RECAPTCHA_ENABLED
# CMD [ "yarn", "run", "dev" ]

RUN yarn build

FROM node:23.11.0-bullseye-slim

WORKDIR /app

ENV LANG=C.UTF-8 \
    TZ=Asia/Tokyo

COPY --from=build-stage /app/.output .output
COPY --from=build-stage /app/package.json ./package.json

ENV NODE_ENV=production

EXPOSE 80

CMD ["node", ".output/server/index.mjs"]