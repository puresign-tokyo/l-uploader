FROM node:23.11.0-bullseye-slim as build-stage

WORKDIR /app
ENV LANG=C.UTF-8 \
    TZ=Asia/Tokyo

COPY ./app /app

RUN yarn install && yarn cache clean

ARG NUXT_PUBLIC_HTTP_PROTOCOL
ARG NUXT_PUBLIC_BACKEND_HOST
ARG NUXT_PUBLIC_BACKEND_PORT
ARG NUXT_PUBLIC_FRONTEND_HOST
ARG NUXT_PUBLIC_FRONTEND_PORT
ARG NUXT_PUBLIC_PAGINATION_LIMIT

ENV NUXT_PUBLIC_HTTP_PROTOCOL=$NUXT_PUBLIC_HTTP_PROTOCOL
ENV NUXT_PUBLIC_BACKEND_HOST=$NUXT_PUBLIC_BACKEND_HOST
ENV NUXT_PUBLIC_BACKEND_PORT=$NUXT_PUBLIC_BACKEND_PORT
ENV NUXT_PUBLIC_FRONTEND_HOST=$NUXT_PUBLIC_FRONTEND_HOST
ENV NUXT_PUBLIC_FRONTEND_PORT=$NUXT_PUBLIC_FRONTEND_PORT
ENV NUXT_PUBLIC_PAGINATION_LIMIT=$NUXT_PUBLIC_PAGINATION_LIMIT

# CMD [ "yarn", "run", "dev" ]

RUN yarn build

FROM node:23.11.0-bullseye-slim

WORKDIR /app

ENV LANG=C.UTF-8 \
    TZ=Asia/Tokyo

COPY --from=build-stage /app/.output .output
COPY --from=build-stage /app/package.json ./package.json

ENV NODE_ENV=production

EXPOSE 80

CMD ["node", ".output/server/index.mjs"]